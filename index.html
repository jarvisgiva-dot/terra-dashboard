<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terra BI v3.0</title>
    
    <!-- Stack: Tailwind (UI), Chart.js (Viz), Alpine.js (Logic/Reactivity) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 1.5rem; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="p-6" x-data="app()" x-init="init()">

    <!-- Security Gate -->
    <div x-show="!authenticated" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="card w-96 text-center">
            <h2 class="text-xl font-bold text-emerald-400 mb-4">üîí STARK BI v3.0</h2>
            <input type="password" x-model="password" class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white mb-4 text-center" placeholder="Senha">
            <button @click="login()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded">ENTRAR</button>
            <p x-show="authError" class="text-red-500 text-xs mt-2">Acesso Negado.</p>
        </div>
    </div>

    <!-- Main BI Interface -->
    <div x-show="authenticated" x-cloak class="max-w-7xl mx-auto space-y-6">
        
        <!-- Top Bar: Global Filters -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-slate-800 p-4 rounded-lg border border-slate-700">
            <div>
                <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                    üöú TERRA BI <span class="text-xs bg-emerald-900 text-emerald-300 px-2 py-1 rounded">LIVE</span>
                </h1>
            </div>
            
            <div class="flex gap-4 mt-4 md:mt-0">
                <!-- Slicer: Safra -->
                <select x-model="filters.safra" class="bg-slate-900 border border-slate-600 text-white rounded p-2 text-sm">
                    <option value="ALL">üìÖ Todas as Safras</option>
                    <template x-for="s in uniqueSafras">
                        <option :value="s" x-text="s"></option>
                    </template>
                </select>

                <!-- Slicer: Cultura -->
                <select x-model="filters.cultura" class="bg-slate-900 border border-slate-600 text-white rounded p-2 text-sm">
                    <option value="ALL">üå± Todas as Culturas</option>
                    <option value="SOJA">SOJA</option>
                    <option value="MILHO">MILHO</option>
                </select>
            </div>
        </header>

        <!-- KPI Deck -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="card border-l-4 border-emerald-500">
                <p class="text-slate-400 text-xs uppercase">Custo Total Realizado</p>
                <p class="text-2xl font-bold text-white" x-text="formatMoney(kpis.custoTotal)"></p>
            </div>
            <div class="card border-l-4 border-blue-500">
                <p class="text-slate-400 text-xs uppercase">√Årea Plantada</p>
                <p class="text-2xl font-bold text-white"><span x-text="formatNumber(kpis.areaTotal)"></span> <span class="text-sm font-normal text-slate-400">ha</span></p>
            </div>
            <div class="card border-l-4 border-yellow-500">
                <p class="text-slate-400 text-xs uppercase">Produtividade M√©dia</p>
                <p class="text-2xl font-bold text-white"><span x-text="formatNumber(kpis.prodMedia)"></span> <span class="text-sm font-normal text-slate-400">sc/ha</span></p>
            </div>
            <div class="card border-l-4 border-purple-500">
                <p class="text-slate-400 text-xs uppercase">Benchmark IMEA (Ref)</p>
                <p class="text-2xl font-bold text-white" x-text="formatMoney(kpis.refImea)"></p>
                <p class="text-xs mt-1" :class="kpis.custoMedioHa > kpis.refImea ? 'text-red-400' : 'text-emerald-400'">
                    <span x-text="kpis.custoMedioHa > kpis.refImea ? '‚ñ≤ Acima' : '‚ñº Abaixo'"></span> da Refer√™ncia
                </p>
            </div>
        </div>

        <!-- Main Visuals -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Breakdown Chart -->
            <div class="card col-span-2">
                <h3 class="text-lg font-bold text-white mb-4">Composi√ß√£o de Custos</h3>
                <div class="h-64">
                    <canvas id="costChart"></canvas>
                </div>
            </div>

            <!-- Produtividade Table (Top Talh√µes) -->
            <div class="card col-span-1 overflow-hidden">
                <h3 class="text-lg font-bold text-white mb-4">Top Performance (sc/ha)</h3>
                <div class="overflow-y-auto h-64">
                    <table class="w-full text-sm text-left text-slate-300">
                        <thead class="text-xs uppercase bg-slate-800 sticky top-0">
                            <tr>
                                <th class="px-2 py-2">Talh√£o</th>
                                <th class="px-2 py-2 text-right">Prod</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="p in filteredProd.sort((a,b) => b.prod_sc_ha - a.prod_sc_ha).slice(0,10)">
                                <tr class="border-b border-slate-700 hover:bg-slate-800">
                                    <td class="px-2 py-2 font-medium text-white">
                                        <div x-text="p.talhao"></div>
                                        <div class="text-xs text-slate-500" x-text="p.variedade"></div>
                                    </td>
                                    <td class="px-2 py-2 text-right font-bold text-emerald-400" x-text="p.prod_sc_ha.toFixed(1)"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Detailed Data Grid -->
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">Base de Dados: Custos</h3>
                <input type="text" x-model="search" placeholder="Buscar item..." class="bg-slate-900 border border-slate-600 rounded p-1 text-sm text-white w-64">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-300">
                    <thead class="text-xs uppercase bg-slate-800 text-slate-400">
                        <tr>
                            <th class="px-4 py-3">Safra</th>
                            <th class="px-4 py-3">Cultura</th>
                            <th class="px-4 py-3">Categoria</th>
                            <th class="px-4 py-3">Item</th>
                            <th class="px-4 py-3 text-right">Valor Total</th>
                            <th class="px-4 py-3 text-right">R$/ha</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="row in paginatedCustos">
                            <tr class="border-b border-slate-700 hover:bg-slate-800 transition">
                                <td class="px-4 py-2" x-text="row.safra"></td>
                                <td class="px-4 py-2"><span class="bg-slate-700 px-2 py-1 rounded text-xs" x-text="row.cultura"></span></td>
                                <td class="px-4 py-2" x-text="row.categoria"></td>
                                <td class="px-4 py-2 font-medium text-white" x-text="row.item"></td>
                                <td class="px-4 py-2 text-right text-emerald-300" x-text="formatMoney(row.valor)"></td>
                                <td class="px-4 py-2 text-right" x-text="formatMoney(row.custo_ha)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <!-- Simple Pagination -->
            <div class="flex justify-center gap-2 mt-4">
                <button @click="page--" :disabled="page===1" class="px-3 py-1 bg-slate-700 rounded disabled:opacity-50 text-xs">Anterior</button>
                <span class="text-xs py-1 text-slate-400">P√°gina <span x-text="page"></span></span>
                <button @click="page++" :disabled="page * pageSize >= filteredCustos.length" class="px-3 py-1 bg-slate-700 rounded disabled:opacity-50 text-xs">Pr√≥xima</button>
            </div>
        </div>

    </div>

    <script>
        function app() {
            return {
                authenticated: false,
                password: '',
                authError: false,
                db: null,
                filters: { safra: 'ALL', cultura: 'ALL' },
                search: '',
                page: 1,
                pageSize: 10,
                chartInstance: null,

                login() {
                    if (this.password === 'jarvis4.0') {
                        this.authenticated = true;
                        this.loadData();
                    } else {
                        this.authError = true;
                    }
                },

                async loadData() {
                    // Fetch generated JSON
                    const res = await fetch('./data/database.json');
                    this.db = await res.json();
                    this.$watch('filters', () => { this.page = 1; this.updateChart(); });
                    this.updateChart();
                },

                get uniqueSafras() {
                    if(!this.db) return [];
                    const safras = new Set(this.db.custos.map(c => c.safra));
                    return Array.from(safras).sort();
                },

                get filteredCustos() {
                    if (!this.db) return [];
                    return this.db.custos.filter(c => {
                        const matchSafra = this.filters.safra === 'ALL' || c.safra === this.filters.safra;
                        const matchCultura = this.filters.cultura === 'ALL' || c.cultura === this.filters.cultura;
                        const matchSearch = this.search === '' || c.item.toLowerCase().includes(this.search.toLowerCase());
                        return matchSafra && matchCultura && matchSearch;
                    });
                },

                get paginatedCustos() {
                    const start = (this.page - 1) * this.pageSize;
                    return this.filteredCustos.slice(start, start + this.pageSize);
                },

                get filteredProd() {
                    if (!this.db) return [];
                    return this.db.produtividade.filter(p => {
                        const matchSafra = this.filters.safra === 'ALL' || p.safra === this.filters.safra;
                        const matchCultura = this.filters.cultura === 'ALL' || p.cultura === this.filters.cultura;
                        return matchSafra && matchCultura;
                    });
                },

                get kpis() {
                    const custos = this.filteredCustos;
                    const prods = this.filteredProd;
                    
                    const custoTotal = custos.reduce((acc, c) => acc + c.valor, 0);
                    const areaTotal = prods.reduce((acc, p) => acc + p.area, 0);
                    const totalSc = prods.reduce((acc, p) => acc + p.total_sc, 0);
                    
                    const prodMedia = areaTotal > 0 ? totalSc / areaTotal : 0;
                    const custoMedioHa = areaTotal > 0 ? custoTotal / areaTotal : 0;

                    // Get IMEA ref
                    let refImea = 0;
                    if (this.db && this.filters.cultura !== 'ALL') {
                        const ref = this.db.referencias.find(r => r.cultura === this.filters.cultura);
                        if(ref) refImea = ref.ref_custo_ha;
                    }

                    return { custoTotal, areaTotal, prodMedia, custoMedioHa, refImea };
                },

                updateChart() {
                    if (!this.db) return;
                    
                    // Group By Category
                    const groups = {};
                    this.filteredCustos.forEach(c => {
                        if (!groups[c.categoria]) groups[c.categoria] = 0;
                        groups[c.categoria] += c.valor;
                    });

                    const labels = Object.keys(groups);
                    const data = Object.values(groups);

                    const ctx = document.getElementById('costChart');
                    
                    if (this.chartInstance) this.chartInstance.destroy();

                    this.chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right', labels: { color: '#cbd5e1' } }
                            }
                        }
                    });
                },

                formatMoney(val) {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
                },
                formatNumber(val) {
                    return new Intl.NumberFormat('pt-BR').format(val);
                }
            }
        }
    </script>
</body>
</html>
